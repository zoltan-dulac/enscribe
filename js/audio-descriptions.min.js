const players={};function htmlToText(e){const t=document.createElement("div");return t.appendChild(e.cloneNode(!0)),t.textContent||""}function getCueData(e){const t=e.getCueAsHTML();return{content:htmlToText(t),pause:null!==t.querySelector("span.pause")}}const getVol=(e,t)=>"html5"===e?Promise.resolve(t.element.volume):"youtube"===e?Promise.resolve(t.youtube.getVolume()/100):t.vimeo.getVolume(),setVol=(e,t,a)=>"html5"===e?t.element.volume=a:"youtube"===e?t.youtube.setVolume(Math.round(100*a)):t.vimeo.setVolume(a);async function speak(e,t,a,o){const n=new SpeechSynthesisUtterance(e);n.volume=await getVol(a,o);const u=o.element,r=t||u.hasAttribute("data-ad-global-pause"),s=u.getAttribute("data-ad-ducking"),i=!r&&null!=s;let c;i&&(c=await getVol(a,o),await setVol(a,o,+s||.25)),o.ADPlaying=!0,speechSynthesis.speak(n),r&&control(a,o,"pause"),n.onend=async()=>{r&&control(a,o,"play"),i&&await setVol(a,o,c),setTimeout(()=>o.ADPlaying=!1,100)}}function control(e,t,a){return"youtube"===e?t.youtube[a+"Video"]():"vimeo"===e?t.vimeo[a]():t.element[a]()}function setupADTrack(e,t){return new Promise(a=>{const o=document.createElement("video");o.preload="metadata",o.style.display="none",document.body.appendChild(o);const n=Object.assign(document.createElement("track"),{kind:"descriptions",label:"Audio Descriptions",srclang:"en",src:t});o.appendChild(n);const u=o.textTracks[0];u.mode="hidden",o.load(),n.addEventListener("load",()=>{e.videoElementProxy=o,e.ADTrack=u,a()},{once:!0})})}async function createExternalTracksFor(e){e.element.dataset.adVideoSource||await setupADTrack(e,e.element.dataset.adPlayerVttPath)}function createPlayerMappings(){document.querySelectorAll("[data-AD-player]").forEach(e=>{const t=e.id,a=e.dataset.adPlayerType;let o=e.querySelector("source")?.src||e.src;if("youtube"===a){const t=/embed\/([^?]+)/.exec(e.src);o=t?t[1]:""}players[t]={element:e,type:a,standardSource:o,ADSource:e.dataset.adVideoSource,enabled:!1,ADPlaying:!1},"html5"===a&&e.textTracks.addEventListener("change",()=>setHTML5TrackMode(players[t]))})}function setHTML5TrackMode(e){e.ADTrack.mode=e.enabled?"showing":"disabled"}const api={html5:{get:e=>({currentTime:e.element.currentTime,isPaused:e.element.paused}),set:(e,t,a,o)=>{e.element.querySelector("source").src=t,e.element.load(),e.element.currentTime=a,o||e.element.play()}},vimeo:{get:async e=>({currentTime:await e.vimeo.getCurrentTime(),isPaused:await e.vimeo.getPaused()}),set:async(e,t,a,o)=>{await e.vimeo.loadVideo(t),await e.vimeo.setCurrentTime(a),o||e.vimeo.play()}},youtube:{get:e=>({currentTime:e.youtube.getCurrentTime(),isPaused:2===e.youtube.getPlayerState()}),set:(e,t,a,o)=>{e.youtube.loadVideoById(t,a);const n=setInterval(()=>{-1===e.youtube.getPlayerState()&&(o?e.youtube.pauseVideo():e.youtube.playVideo(),clearInterval(n))},100)}}};async function updateSourceVideo(e,t){"youtube"!==t.type||t.youtube||await setupYouTube(t),"vimeo"!==t.type||t.vimeo||await setupVimeo(t);const{currentTime:a,isPaused:o}=await api[t.type].get(t),n="AD"===e?t.ADSource:t.standardSource;await api[t.type].set(t,n,a,o)}function setupHTML5(e){for(const t of e.element.textTracks)"descriptions"===t.kind&&(e.ADTrack=t,t.addEventListener("cuechange",async t=>{if(e.ADPlaying)return;const a=t.currentTarget.activeCues[0];a&&await speak(...Object.values(getCueData(a)),"html5",e)}))}async function setupVimeo(e){if(await createExternalTracksFor(e),await loadScript("https://player.vimeo.com/api/player.js"),e.vimeo=new Vimeo.Player(e.element),e.ADTrack){for(const t of e.ADTrack.cues){const{content:a,pause:o}=getCueData(t);e.vimeo.addCuePoint(t.startTime,{content:a,pause:o})}e.vimeo.on("cuepoint",t=>e.enabled&&speak(t.data.content,t.data.pause,"vimeo",e))}}let ytReady;function loadYouTube(){return ytReady||(ytReady=new Promise(e=>{window.onYouTubeIframeAPIReady=e,loadScript("https://www.youtube.com/iframe_api")}),ytReady)}async function setupYouTube(e){await createExternalTracksFor(e),await loadYouTube(),e.youtube=new YT.Player(e.element.id,{events:{onStateChange:t=>{t.data===YT.PlayerState.UNSTARTED||e._pollStarted||e.element.dataset.adVideoSource||(e._pollStarted=!0,pollYouTubeAD(e))}}})}function buildAudioDescriptions(){if(document.querySelectorAll("[data-AD-player]").length)for(const e of Object.values(players))"html5"===e.type?e.element.dataset.adVideoSource||setupHTML5(e):"vimeo"===e.type?setupVimeo(e):"youtube"===e.type&&setupYouTube(e)}function pollYouTubeAD(e){e._ytInterval=setInterval(()=>{if(!e.enabled||e.ADPlaying||!e.youtube?.getCurrentTime)return;const t=e.youtube.getCurrentTime();null!=e._lastTime&&t<e._lastTime-.2&&(e._recentCue=void 0),e._lastTime=t;for(const a of e.ADTrack.cues)if(e._recentCue!==a.startTime&&Math.abs(t-a.startTime)<=.1)return e._recentCue=a.startTime,speak(...Object.values(getCueData(a)),"youtube",e)},100)}function loadScript(e){return new Promise(t=>{const a=document.createElement("script");a.onload=t,a.src=e,document.head.appendChild(a)})}function setupToggleButtons(){document.querySelectorAll("[data-AD-button]").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget,a=t.dataset.adAssociatedPlayer,o=players[a];o.enabled=!o.enabled,t.classList.toggle("active"),t.setAttribute("aria-label",`Turn ${o.enabled?"off":"on"} audio descriptions`),o.ADSource?updateSourceVideo(o.enabled?"AD":"standard",o):"html5"===o.type&&setHTML5TrackMode(o)})})}createPlayerMappings(),buildAudioDescriptions(),setupToggleButtons();