{
  "version": 3,
  "sources": ["../es6/enscribe-youtube.js", "../es6/enscribe.js"],
  "sourcesContent": ["// enscribe-youtube.js\nimport { register, getCueData, speak } from './enscribe.js';\n\nlet ytReady;\nfunction loadYT() {\n  if (ytReady) return ytReady;\n  ytReady = new Promise((res) => {\n    window.onYouTubeIframeAPIReady = res;\n    const s = document.createElement('script');\n    s.src = 'https://www.youtube.com/iframe_api';\n    document.head.appendChild(s);\n  });\n  return ytReady;\n}\n\nconst mod = {\n  getVolume: (p) => Promise.resolve(p.youtube.getVolume() / 100),\n  setVolume: (p, v) => p.youtube.setVolume(Math.round(v * 100)),\n  control: (p, action) => p.youtube[action + 'Video'](),\n\n  async updateSource(p, which) {\n    const id = which === 'AD' ? p.ADSource : p.standardSource;\n    const cur = p.youtube.getCurrentTime();\n    const paused = p.youtube.getPlayerState() === 2;\n    p.youtube.loadVideoById(id, cur);\n    const poll = setInterval(() => {\n      if (p.youtube.getPlayerState() === -1) {\n        paused ? p.youtube.pauseVideo() : p.youtube.playVideo();\n        clearInterval(poll);\n      }\n    }, 100);\n  },\n\n  async setup(p) {\n    // If not using an alternate AD video, build a proxy descriptions track\n    if (!p.element.dataset.adVideoSource) {\n      const v = document.createElement('video');\n      const t = Object.assign(document.createElement('track'), {\n        kind: 'descriptions', label: 'Audio Descriptions', srclang: 'en',\n        src: p.element.dataset.adPlayerVttPath\n      });\n      v.appendChild(t);\n      const tt = v.textTracks[0];\n      tt.mode = 'hidden';\n      t.addEventListener('load', () => { p.ADTrack = tt; }, { once: true });\n      document.body.appendChild(v);\n    }\n\n    await loadYT();\n    p.youtube = new YT.Player(p.element.id, {\n      events: {\n        onStateChange: (e) => {\n          if (e.data !== YT.PlayerState.UNSTARTED && !p._pollStarted && !p.element.dataset.adVideoSource) {\n            p._pollStarted = true;\n            const tick = () => {\n              if (!p.enabled || p.ADPlaying || !p.youtube?.getCurrentTime) return;\n              const now = p.youtube.getCurrentTime();\n              if (p._lastTime != null && now < p._lastTime - 0.2) p._recentCue = undefined;\n              p._lastTime = now;\n              for (const c of p.ADTrack.cues) {\n                if (p._recentCue === c.startTime) continue;\n                if (Math.abs(now - c.startTime) <= 0.1) {\n                  p._recentCue = c.startTime;\n                  return speak(...Object.values(getCueData(c)), p);\n                }\n              }\n            };\n            p._ytInterval = setInterval(tick, 100);\n          }\n        }\n      }\n    });\n  }\n};\n\nregister('youtube', mod);\nexport default mod;\n", "/* enscribe.js \u2014 ES module core */\n\nconst en = {\n    players: new Map(),\n    mods: new Map(),     // type -> module (html5|vimeo|youtube|\u2026)\n    urls: new Map(),     // type -> absolute URL to plugin file\n    ready: false\n  };\n  \n  // Base-path from this file\n  const isES6Module = !(document.currentScript);\n  console.log('es6mod', isES6Module);\n  const baseURL = new URL('.', isES6Module ? import.meta.url : location.origin + location.pathname.replace(/\\/[^/]*$/, '/') + enableRootDir);\n  console.log('url', baseURL);\n  // Default URL resolver: ./enscribe-${type}.js next to enscribe.js\n  const defaultURLFor = (type) => new URL(`./enscribe-${type}.js`, baseURL).href;\n  \n  // Public: allow apps to override plugin URL mapping\n  export function setPluginURL(type, url) {\n    en.urls.set(type, new URL(url, baseURL).href);\n  }\n  \n  // Public: register a plugin module {setup, control, getVolume, setVolume, updateSource, ...}\n  export function register(type, mod) {\n    en.mods.set(type, mod);\n  }\n  \n  // Helpers used by plugins\n  export function htmlToText(html) {\n    const d = document.createElement('div');\n    d.appendChild(html.cloneNode(true));\n    return d.textContent || '';\n  }\n  \n  export function getCueData(cue) {\n    const h = cue.getCueAsHTML();\n    return { content: htmlToText(h), pause: !!h.querySelector('span.pause') };\n  }\n  \n  // Speak + (optional) pause/duck\n  export async function speak(content, pause, player) {\n    const mod = en.mods.get(player.type);\n    if (!mod) return;\n  \n    const u = new SpeechSynthesisUtterance(content);\n    if (mod.getVolume) u.volume = await mod.getVolume(player);\n  \n    const el = player.element;\n    const shouldPause = pause || el.hasAttribute('data-ad-global-pause');\n    const duckAttr = el.getAttribute('data-ad-ducking');\n    const shouldDuck = !shouldPause && duckAttr != null;\n    let prev;\n  \n    if (shouldDuck && mod.getVolume && mod.setVolume) {\n      prev = await mod.getVolume(player);\n      await mod.setVolume(player, +duckAttr || 0.25);\n    }\n  \n    player.ADPlaying = true;\n    speechSynthesis.speak(u);\n    if (shouldPause && mod.control) mod.control(player, 'pause');\n  \n    u.onend = async () => {\n      if (shouldPause && mod.control) mod.control(player, 'play');\n      if (shouldDuck && mod.setVolume) await mod.setVolume(player, prev);\n      setTimeout(() => (player.ADPlaying = false), 100);\n    };\n  }\n  \n  // Utility: script loader (rarely needed now that we use import(); still here if you want it)\n  export function loadScript(src) {\n    return new Promise((r) => {\n      const s = document.createElement('script');\n      s.onload = r;\n      s.src = src;\n      document.head.appendChild(s);\n    });\n  }\n  \n  // Dynamic import for a given type\n  async function ensure(type) {\n    if (en.mods.has(type)) return;\n    const url = en.urls.get(type) || defaultURLFor(type);\n    const mod = await import(url);\n    // plugin can either default-export the module object or export {plugin}\n    register(type, mod.default || mod.plugin || mod);\n  }\n  \n  // Map DOM -> players\n  export function createPlayerMappings() {\n    document.querySelectorAll('[data-AD-player]').forEach((el) => {\n      const type = el.dataset.adPlayerType;\n      let standardSource = el.querySelector('source')?.src || el.src;\n      if (type === 'youtube') {\n        const m = /embed\\/([^?]+)/.exec(el.src);\n        standardSource = m ? m[1] : '';\n      }\n      en.players.set(el.id, {\n        element: el,\n        type,\n        standardSource,\n        ADSource: el.dataset.adVideoSource,\n        enabled: false,\n        ADPlaying: false,\n      });\n    });\n  }\n  \n  // Public: let apps manually toggle a player by id\n  export function setEnabled(playerId, enabled) {\n    const p = en.players.get(playerId);\n    if (!p) return;\n    p.enabled = enabled;\n    const mod = en.mods.get(p.type);\n    if (p.type === 'html5' && mod?.setHTML5TrackMode) mod.setHTML5TrackMode(p);\n  }\n  \n  // Hook up UI buttons\n  export function setupToggleButtons() {\n    document.querySelectorAll('[data-AD-button]').forEach((btn) => {\n      btn.addEventListener('click', async (e) => {\n        const el = e.currentTarget;\n        const p = en.players.get(el.dataset.adAssociatedPlayer);\n        if (!p) return;\n        p.enabled = !p.enabled;\n        el.classList.toggle('active');\n        el.setAttribute('aria-label', `Turn ${p.enabled ? 'off' : 'on'} audio descriptions`);\n        const mod = en.mods.get(p.type);\n        if (p.ADSource && mod?.updateSource) {\n          await mod.updateSource(p, p.enabled ? 'AD' : 'standard');\n        } else if (p.type === 'html5' && mod?.setHTML5TrackMode) {\n          mod.setHTML5TrackMode(p);\n        }\n      });\n    });\n  }\n  \n  // Public: initialize everything (dynamic plugin loading by type)\n  export async function init() {\n    console.log('init'); \n    if (en.ready) return;\n    en.ready = true;\n  \n    createPlayerMappings();\n  \n    // Load & setup each player\u2019s plugin\n    for (const p of en.players.values()) {\n      await ensure(p.type);\n      const mod = en.mods.get(p.type);\n      if (mod?.setup) await mod.setup(p, { speak, getCueData });\n    }\n  \n    setupToggleButtons();\n  }\n\n  init();\n  "],
  "mappings": "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",
  "names": ["mod", "mod", "mod"]
}
